generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  passwordHash        String?  @map("password_hash")
  name                String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  subscriptionTier    String   @default("community") @map("subscription_tier")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  isActive            Boolean  @default(true) @map("is_active")

  connectedAccounts   ConnectedAccount[]
  migrationJobs       MigrationJob[]
  auditLogs           AuditLog[]

  @@map("users")
  @@index([email])
  @@index([subscriptionTier])
}

model ConnectedAccount {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  platform            String
  platformAccountId   String?  @map("platform_account_id")
  platformAccountName String?  @map("platform_account_name")

  accessToken         String   @map("access_token")
  refreshToken        String?  @map("refresh_token")
  tokenExpiresAt      DateTime? @map("token_expires_at")

  connectedAt         DateTime @default(now()) @map("connected_at")
  lastSyncedAt        DateTime? @map("last_synced_at")
  status              String   @default("active")

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  migrationJobs       MigrationJob[]
  sourceSchema        SourceSchema?

  @@unique([userId, platform, platformAccountId])
  @@map("connected_accounts")
  @@index([userId])
  @@index([platform])
}

model MigrationJob {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")

  sourcePlatform      String   @map("source_platform")
  sourceAccountId     String?  @map("source_account_id")
  selectedEntities    Json?    @map("selected_entities")

  destinationType     String   @map("destination_type")
  destinationConfig   Json?    @map("destination_config")

  status              String   @default("pending")
  progress            Int      @default(0)

  recordsTotal        Int?     @map("records_total")
  recordsProcessed    Int      @default(0) @map("records_processed")
  bytesDownloaded     BigInt   @default(0) @map("bytes_downloaded")

  createdAt           DateTime @default(now()) @map("created_at")
  startedAt           DateTime? @map("started_at")
  completedAt         DateTime? @map("completed_at")

  outputPath          String?  @map("output_path")
  downloadUrl         String?  @map("download_url")
  errorMessage        String?  @map("error_message")
  validationReport    Json?    @map("validation_report")

  options             Json?

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceAccount       ConnectedAccount? @relation(fields: [sourceAccountId], references: [id])
  auditLogs           AuditLog[]

  @@map("migration_jobs")
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([sourcePlatform])
}

model SourceSchema {
  id                  String   @id @default(uuid())
  connectedAccountId  String   @unique @map("connected_account_id")
  platform            String

  schemaData          Json     @map("schema_data")

  extractedAt         DateTime @default(now()) @map("extracted_at")
  expiresAt           DateTime? @map("expires_at")

  connectedAccount    ConnectedAccount @relation(fields: [connectedAccountId], references: [id], onDelete: Cascade)

  @@map("source_schemas")
  @@index([connectedAccountId])
}

model Connector {
  id                  String   @id @default(uuid())
  platformName        String   @unique @map("platform_name")
  displayName         String   @map("display_name")
  description         String?
  logoUrl             String?  @map("logo_url")

  version             String?
  tier                String   @default("community")

  capabilities        Json?
  rateLimits          Json?    @map("rate_limits")

  documentationUrl    String?  @map("documentation_url")
  setupGuideUrl       String?  @map("setup_guide_url")

  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")

  @@map("connectors")
  @@index([tier])
}

model AuditLog {
  id                  String   @id @default(uuid())
  userId              String?  @map("user_id")
  jobId               String?  @map("job_id")

  action              String
  details             Json?

  ipAddress           String?  @map("ip_address")
  userAgent           String?  @map("user_agent")

  createdAt           DateTime @default(now()) @map("created_at")

  user                User?    @relation(fields: [userId], references: [id])
  job                 MigrationJob? @relation(fields: [jobId], references: [id])

  @@map("audit_logs")
  @@index([userId, createdAt(sort: Desc)])
  @@index([jobId])
  @@index([createdAt(sort: Desc)])
}
